import asyncio
import random
from telethon import TelegramClient, events
from telethon.sessions import StringSession
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
api_id = 29140676
api_hash = "4243c5d2b35d3a536dac64edbbefb76f"
session_string = "1BJWap1wBu6PfYH1MMMyBc9ENbDr0aZgUU67iDQHUHX6opLHsmaJ-ko3x4G-QVJMCddR8gfbkWTwEUZBiFw5VIMDQymWJw2ewrbdo0p1OlgxetYSxXww5-6Ttxr2KxZGITikedAXrtKmim7ly3ocwF1YzLf9pbBK0kKSFhjlybeoj8dDTL8R6WH0s4I6Cqvq1VJ-pXKpdQlgbMpJCtR1g0c-BML0ohxxBZD8DtcPBiL-fjdVwxOhqkZR6gSdGUDPInctB6aFWGbCzbo9YSNS1YUzVbfnCIKGnd4j-RwobBDLKVaO5Vl6cc41-tRCeXrJkkgb2NlCDkq9BUBYgMLyHKUUInnYo9wA="  # Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù„Ø³Ø©
bot_token = "7415434367:AAH6FIBRJP95xrPkKLZYocPktnrc1wptZVk"
OWNER_ID = 7290314430  # Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø§Ù„Ùƒ

# Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
target_chat = None
target_users = []  # Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
private_targets = []  # Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
messages_list = ["Ù…Ø±Ø­Ø¨Ø§", "ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ", "Ø§Ù‡Ù„Ø§"]
is_running = False
delay = 2  # Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
private_mode = False  # ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø§Øµ
random_reply = True  # Ù‡Ù„ ÙŠØ±Ø¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ø£Ù… Ù„Ø§
reply_probability = 50  # Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (50%)
current_input_state = None  # Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©

# ØªØªØ¨Ø¹ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯
last_message_id = None
reply_task = None
last_sent_message = None  # Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†ÙØ³Ù‡Ø§

# ØªÙ‡ÙŠØ¦Ø© Telethon Ùˆ Aiogram
client = TelegramClient(StringSession(session_string), api_id, api_hash)
bot = Bot(token=bot_token)
dp = Dispatcher(bot)

async def send_reply(chat_id, reply_to):
    global last_sent_message
    
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©
        available_messages = [msg for msg in messages_list if msg != last_sent_message]
        if not available_messages:  # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…ØªØ´Ø§Ø¨Ù‡Ø©
            available_messages = messages_list.copy()
            
        message = random.choice(available_messages)
        last_sent_message = message
        
        if random_reply and random.randint(1, 100) <= reply_probability:
            await client.send_message(
                entity=chat_id,
                message=message,
                reply_to=reply_to
            )
            print(f"ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© {reply_to} Ø¨Ù€: {message}")
        else:
            await client.send_message(
                entity=chat_id,
                message=message
            )
            print(f"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: {message}")
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {str(e)}")

async def continuous_replying(chat_id):
    global last_message_id
    while is_running:
        if last_message_id:
            await send_reply(chat_id, last_message_id)
        await asyncio.sleep(delay)

@client.on(events.NewMessage)
async def handle_new_message(event):
    global last_message_id, reply_task

    if not is_running:
        return

    try:
        sender = await event.get_sender()
        chat_id = str(event.chat_id).replace("-", "")
        
        if private_mode:
            if str(sender.id) in private_targets:
                last_message_id = event.id
                if reply_task is None:
                    reply_task = asyncio.create_task(continuous_replying(event.chat_id))
        else:
            if target_chat and int(chat_id) == target_chat:
                for user in target_users:
                    if (user.isdigit() and sender.id == int(user)) or \
                       (sender.username and sender.username.lower() == user.lower()):
                        last_message_id = event.id
                        if reply_task is None:
                            reply_task = asyncio.create_task(continuous_replying(event.chat_id))
                        break

    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {str(e)}")

def get_control_panel():
    buttons = [
        [InlineKeyboardButton("ØªØ´ØºÙŠÙ„ âœ…" if is_running else "Ø¥ÙŠÙ‚Ø§Ù â›”", callback_data="toggle")],
        [
            InlineKeyboardButton("ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±ÙˆØ¨", callback_data="set_group_mode"),
            InlineKeyboardButton("ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø§Øµ", callback_data="set_private_mode")
        ],
        [
            InlineKeyboardButton("Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data="add_users"),
            InlineKeyboardButton("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data="manage_users")
        ],
        [
            InlineKeyboardButton("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„", callback_data="set_msgs"),
            InlineKeyboardButton("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø±Ø¹Ø©", callback_data="set_delay"),
            InlineKeyboardButton("Ø¶Ø¨Ø· Ø§Ù„Ø±Ø¯ÙˆØ¯", callback_data="set_reply_mode")
        ],
        [InlineKeyboardButton("Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", callback_data="status")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

@dp.message_handler(commands=['start'])
async def start_command(message: types.Message):
    if message.from_user.id == OWNER_ID:
        await message.reply("ğŸš€ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø¢Ù„ÙŠ", reply_markup=get_control_panel())
    else:
        await message.reply("â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…")

@dp.message_handler(commands=['start_private'])
async def start_private_command(message: types.Message):
    if message.from_user.id != OWNER_ID:
        await message.reply("â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±")
        return
    
    args = message.get_args()
    if not args:
        await message.reply("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢ÙŠØ¯ÙŠØ§Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„:\n/start_private 123456789.987654321")
        return
    
    global private_targets, private_mode, is_running
    private_targets = [uid.strip() for uid in args.split(".") if uid.strip()]
    private_mode = True
    is_running = True
    
    await message.reply(
        f"âœ… ØªÙ… ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø§Øµ Ø¹Ù„Ù‰ {len(private_targets)} Ù…Ø³ØªØ®Ø¯Ù…:\n" +
        "\n".join([f"â€¢ {uid}" for uid in private_targets]),
        reply_markup=get_control_panel()
    )

@dp.callback_query_handler()
async def callback_handler(query: types.CallbackQuery):
    global current_input_state
    
    if query.from_user.id != OWNER_ID:
        await query.answer("â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„", show_alert=True)
        return
        
    global is_running, target_chat, target_users, private_targets, messages_list, delay, reply_task, private_mode, random_reply, reply_probability

    try:
        if query.data == "toggle":
            is_running = not is_running
            if not is_running and reply_task:
                reply_task.cancel()
                reply_task = None
            await query.message.edit_reply_markup(reply_markup=get_control_panel())
            await query.answer(f"ØªÙ… {'ØªØ´ØºÙŠÙ„' if is_running else 'Ø¥ÙŠÙ‚Ø§Ù'} Ø§Ù„Ø¨ÙˆØª")

        elif query.data == "set_group_mode":
            private_mode = False
            await query.answer("ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±ÙˆØ¨")
            await query.message.edit_reply_markup(reply_markup=get_control_panel())

        elif query.data == "set_private_mode":
            private_mode = True
            await query.answer("ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø§Øµ")
            await query.message.edit_reply_markup(reply_markup=get_control_panel())

        elif query.data == "add_users":
            current_input_state = "add_users"
            if private_mode:
                await query.message.edit_text("ğŸ‘¤ Ø£Ø±Ø³Ù„ Ø¢ÙŠØ¯ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ø®Ø§Øµ Ù…ÙØµÙˆÙ„Ø© Ø¨Ù†Ù‚Ø§Ø· (Ù…Ø«Ø§Ù„: 123456789.987654321):")
            else:
                await query.message.edit_text("ğŸ‘¥ Ø£Ø±Ø³Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø£Ùˆ Ø§Ù„Ø¢ÙŠØ¯ÙŠØ§Øª Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (Ù…Ø«Ø§Ù„: user1,123456,@user2):")

        elif query.data == "manage_users":
            users_list = private_targets if private_mode else target_users
            users_text = "\n".join([f"{i+1}. {user}" for i, user in enumerate(users_list)]) if users_list else "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¶Ø§ÙÙŠÙ†"
            
            await query.message.edit_text(
                f"ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ† ({'Ø§Ù„Ø®Ø§Øµ' if private_mode else 'Ø§Ù„Ù‚Ø±ÙˆØ¨'}):\n{users_text}\n\n"
                "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton("Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…", callback_data="add_user"),
                     InlineKeyboardButton("Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…", callback_data="remove_user")],
                    [InlineKeyboardButton("Ø­Ø°Ù Ø§Ù„ÙƒÙ„", callback_data="clear_users"),
                     InlineKeyboardButton("Ø±Ø¬ÙˆØ¹", callback_data="back")]
                ])
            )

        elif query.data == "add_user":
            current_input_state = "add_user"
            await query.message.edit_text("ğŸ‘¤ Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ù„Ø¥Ø¶Ø§ÙØªÙ‡:")

        elif query.data == "remove_user":
            users_list = private_targets if private_mode else target_users
            if not users_list:
                await query.answer("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ø¥Ø²Ø§Ù„ØªÙ‡Ù…", show_alert=True)
                return
                
            buttons = [
                [InlineKeyboardButton(user, callback_data=f"remove_{i}")] 
                for i, user in enumerate(users_list)
            ]
            buttons.append([InlineKeyboardButton("Ø±Ø¬ÙˆØ¹", callback_data="manage_users")])
            await query.message.edit_text(
                "Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø­Ø°ÙÙ‡:",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons)
            )

        elif query.data.startswith("remove_"):
            index = int(query.data.split("_")[1])
            if private_mode:
                removed_user = private_targets.pop(index)
            else:
                removed_user = target_users.pop(index)
                
            await query.message.edit_text(
                f"âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {removed_user}",
                reply_markup=get_control_panel())
            await query.answer(f"ØªÙ… Ø­Ø°Ù {removed_user}")

        elif query.data == "clear_users":
            if private_mode:
                private_targets.clear()
            else:
                target_users.clear()
            await query.answer("âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", show_alert=True)
            await query.message.edit_reply_markup(reply_markup=get_control_panel())

        elif query.data == "back":
            current_input_state = None
            await query.message.edit_text("ğŸš€ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø¢Ù„ÙŠ", reply_markup=get_control_panel())

        elif query.data == "set_msgs":
            current_input_state = "set_msgs"
            await query.message.edit_text("ğŸ’¬ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (Ù…Ø«Ø§Ù„: Ø§Ù‡Ù„Ø§,Ù…Ø±Ø­Ø¨Ø§,ÙƒÙŠÙÙƒ):")

        elif query.data == "set_delay":
            current_input_state = "set_delay"
            await query.message.edit_text("â± Ø£Ø±Ø³Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙƒØ³Ø± Ù…Ø«Ù„ 0.1):")

        elif query.data == "set_reply_mode":
            await query.message.edit_text(
                "ğŸ”€ Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¯:\n\n"
                "1. Ø§Ù„Ø±Ø¯ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (50% Ø±Ø¯ØŒ 50% Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©)\n"
                "2. Ø§Ù„Ø±Ø¯ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„\n"
                "3. Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹\n\n"
                "Ø£Ùˆ Ø£Ø±Ø³Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù„Ù„Ø±Ø¯ (Ù…Ø«Ø§Ù„: 70 Ù„Ø¶Ø¨Ø· 70% Ø±Ø¯ÙˆØ¯ Ùˆ30% Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©)",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton("ÙˆØ¶Ø¹ Ø¹Ø´ÙˆØ§Ø¦ÙŠ (50%)", callback_data="set_random_reply")],
                    [InlineKeyboardButton("Ø§Ù„Ø±Ø¯ Ø¯Ø§Ø¦Ù…Ø§Ù‹", callback_data="set_always_reply")],
                    [InlineKeyboardButton("Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹", callback_data="set_never_reply")],
                    [InlineKeyboardButton("Ø±Ø¬ÙˆØ¹", callback_data="back")]
                ])
            )

        elif query.data == "set_random_reply":
            random_reply = True
            reply_probability = 50
            await query.answer("âœ… ØªÙ… Ø¶Ø¨Ø· ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ (50%)")
            await query.message.edit_reply_markup(reply_markup=get_control_panel())

        elif query.data == "set_always_reply":
            random_reply = True
            reply_probability = 100
            await query.answer("âœ… ØªÙ… Ø¶Ø¨Ø· ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¯ Ø¯Ø§Ø¦Ù…Ø§Ù‹")
            await query.message.edit_reply_markup(reply_markup=get_control_panel())

        elif query.data == "set_never_reply":
            random_reply = False
            await query.answer("âœ… ØªÙ… Ø¶Ø¨Ø· ÙˆØ¶Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹")
            await query.message.edit_reply_markup(reply_markup=get_control_panel())

        elif query.data == "status":
            current_users = private_targets if private_mode else target_users
            users_text = "\n".join(current_users) if current_users else "âŒ ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
            
            reply_mode = ""
            if not random_reply:
                reply_mode = "Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹"
            elif reply_probability == 100:
                reply_mode = "Ø§Ù„Ø±Ø¯ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„"
            else:
                reply_mode = f"Ø±Ø¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ({reply_probability}% Ø±Ø¯ÙˆØ¯)"
            
            status = (
                f"âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:\n"
                f"â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: {'ğŸŸ¢ Ù†Ø´Ø·' if is_running else 'ğŸ”´ Ù…ØªÙˆÙ‚Ù'}\n"
                f"â€¢ Ø§Ù„ÙˆØ¶Ø¹: {'ğŸ”µ Ø®Ø§Øµ' if private_mode else 'ğŸŸ  Ù‚Ø±ÙˆØ¨'}\n"
                f"â€¢ {'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†' if private_mode else 'Ø§Ù„Ù‚Ø±ÙˆØ¨'}: \n{users_text}\n"
                f"â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: {len(messages_list)}\n"
                f"â€¢ Ø§Ù„Ø³Ø±Ø¹Ø©: ÙƒÙ„ {delay} Ø«Ø§Ù†ÙŠØ©\n"
                f"â€¢ ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¯: {reply_mode}"
            )
            await query.message.edit_text(status, reply_markup=get_control_panel())

    except Exception as e:
        print(f"Error in callback: {str(e)}")
        await query.answer("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")

@dp.message_handler(content_types=types.ContentTypes.TEXT)
async def handle_text_input(message: types.Message):
    global current_input_state, target_users, private_targets, messages_list, delay, reply_probability, random_reply
    
    if message.from_user.id != OWNER_ID:
        await message.reply("â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„")
        return
    
    if current_input_state == "add_users":
        if private_mode:
            users = message.text.strip().replace("@", "").split(".")
            private_targets = [user.strip() for user in users if user.strip()]
            await message.reply(f"âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {len(private_targets)} Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø®Ø§Øµ", reply_markup=get_control_panel())
        else:
            users = message.text.strip().replace("@", "").split(",")
            target_users = [user.strip() for user in users if user.strip()]
            await message.reply(f"âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† {len(target_users)} Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", reply_markup=get_control_panel())
        current_input_state = None
    
    elif current_input_state == "add_user":
        user = message.text.strip().replace("@", "")
        if private_mode:
            if user not in private_targets:
                private_targets.append(user)
                await message.reply(f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø®Ø§Øµ: {user}", reply_markup=get_control_panel())
            else:
                await message.reply(f"âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user} Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø§Øµ", reply_markup=get_control_panel())
        else:
            if user not in target_users:
                target_users.append(user)
                await message.reply(f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù‚Ø±ÙˆØ¨: {user}", reply_markup=get_control_panel())
            else:
                await message.reply(f"âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user} Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø±ÙˆØ¨", reply_markup=get_control_panel())
        current_input_state = None
    
    elif current_input_state == "set_msgs":
        messages_list = [msg.strip() for msg in message.text.split(",") if msg.strip()]
        await message.reply(f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ({len(messages_list)} Ø±Ø³Ø§Ù„Ø©)", reply_markup=get_control_panel())
        current_input_state = None
    
    elif current_input_state == "set_delay":
        try:
            delay_input = float(message.text.strip())
            if delay_input < 0.1:
                await message.reply("âŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø±Ø¹Ø© Ù‡Ùˆ 0.1 Ø«Ø§Ù†ÙŠØ©", reply_markup=get_control_panel())
            else:
                delay = delay_input
                await message.reply(f"âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø±Ø¹Ø©: ÙƒÙ„ {delay} Ø«Ø§Ù†ÙŠØ©", reply_markup=get_control_panel())
        except ValueError:
            await message.reply("âŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø£Ùˆ ÙƒØ³Ø± Ø¹Ø´Ø±ÙŠ", reply_markup=get_control_panel())
        current_input_state = None
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„
    elif message.text.strip().isdigit() and 1 <= int(message.text.strip()) <= 100:
        reply_probability = int(message.text.strip())
        random_reply = True
        await message.reply(f"âœ… ØªÙ… Ø¶Ø¨Ø· Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ {reply_probability}%", reply_markup=get_control_panel())

async def main():
    await client.start()
    print("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„ÙŠØ«ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­")
    await dp.start_polling()

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª")
    except Exception as e:
        print(f"Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {str(e)}")